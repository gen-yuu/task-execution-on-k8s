apiVersion: batch/v1
kind: Job
metadata:
  name: task-runner-job
spec:
  completionMode: Indexed
  completions: 3000 # „Åì„ÅÆJob„ÅßÂÆå‰∫Ü„Åï„Åõ„ÇãPod„ÅÆÁ∑èÊï∞ („Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅØ0„Åã„Çâ2999„Åæ„Åß)
  parallelism: 1 # ÂêåÊôÇ„Å´ÂÆüË°å„Åô„ÇãPod„ÅÆÊúÄÂ§ßÊï∞(‰ªäÂõûGPU1Êûö„Å™„ÅÆ„Åß„Åì„ÅÆË®≠ÂÆö)
  backoffLimitPerIndex: 1 # „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åî„Å®„Å´POD„Çí2Âõû„Åæ„Åß„ÇÑ„ÇäÁõ¥„Åô
  ttlSecondsAfterFinished: 60 # ÁµÇ‰∫ÜÂæå1ÂàÜ„ÅßËá™ÂãïÂâäÈô§

  template:
    spec:
      restartPolicy: Never
      containers:
        - name: task-runner-container
          image: genyuuu/task-runner-pytorch:v1.1
          command:
            - /bin/bash
            - -c
            - |
              # START_INDEX„ÅåÊú™Ë®≠ÂÆö„Å™„Çâ0„Çí„ÄÅË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Åù„ÅÆÂÄ§„Çí‰Ωø„ÅÜ
              EFFECTIVE_START_INDEX=${START_INDEX:-0}
              ACTUAL_INDEX=$(( EFFECTIVE_START_INDEX + JOB_COMPLETION_INDEX ))
              echo "Executing: K8s Index=${JOB_COMPLETION_INDEX}, Start Index=${EFFECTIVE_START_INDEX}, Actual Task Index=${ACTUAL_INDEX}"

              # ---------- ÂÆü„Çø„Çπ„ÇØ ----------
              # python„ÅÆÁµÇ‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁ¢∫ÂÆü„Å´ÂèñÂæó„Åô„Çã„Åü„ÇÅ„ÄÅ‰∏ÄÊôÇÁöÑ„Å´„Ç®„É©„Éº„ÅßÁµÇ‰∫Ü„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
              set +e
              JOB_COMPLETION_INDEX=$ACTUAL_INDEX python main.py

              # main.py„ÅÆÁµÇ‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ„Çí‰øùÊåÅ
              status=$?
              set -e
              echo "Task ${ACTUAL_INDEX} finished with status ${status}"

              # ---------- ÂÆüË°åÁµêÊûú„Å´Âøú„Åò„ÅüSlackÈÄöÁü• ----------
              if [ $status -ne 0 ]; then
                # =====„ÄêÂ§±ÊïóÊôÇ„ÅÆÈÄöÁü•„Äë=====
                msg="*${NODE_NAME}*\n> Message: üö® JobÂ§±Êïó\n> JOB_NAME: \`${JOB_NAME}\`\n> Task Index: \`${ACTUAL_INDEX}\`\n> Exit Code: \`${status}\`"
                echo "Sending failure notification to Slack..."
                curl -s -X POST -H 'Content-Type: application/json' \
                    --data "{\"text\":\"${msg}\"}" \
                    "$SLACK_WEBHOOK_URL"
              else
                # =====„ÄêÊàêÂäüÊôÇ„ÅÆÈÄöÁü•„Äë=====
                # 10%Âàª„Åø„ÄÅ„Åæ„Åü„ÅØÊúÄÂæå„ÅÆ„Çø„Çπ„ÇØ„ÅåÂÆå‰∫Ü„Åó„ÅüÂ†¥Âêà„Å´ÈÄöÁü•
                ORIGINAL_TOTAL=${ORIGINAL_TOTAL_COMPLETIONS:-${TOTAL_COMPLETIONS}}
                TOTAL=$ORIGINAL_TOTAL
                STEP=$(( (TOTAL + 9) / 10 ))  # 10%Âàª„Åø

                idx=$(( ACTUAL_INDEX  + 1 ))

                if (( idx % STEP == 0 || idx == TOTAL )); then
                  percent=$(( (idx * 100 + TOTAL/2) / TOTAL ))   # ÂõõÊç®‰∫îÂÖ•

                  if (( percent == 100 )); then
                    # ===== 100 %: ÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏ =====
                    msg="*${NODE_NAME}*\n> Message: üéâ JobÂÆå‰∫Ü\n> JOB_NAME: \`${JOB_NAME}\`\n> Progress: \`${percent}%\`\n> Completed Tasks: \`${idx}/${TOTAL}\`" 
                  else
                    # ===== ÈÄöÂ∏∏ 10 % „Åî„Å®„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ =====
                    msg="*${NODE_NAME}*\n> Message: ‚úÖ JobÈÄ≤Ë°å‰∏≠\n> JOB_NAME: \`${JOB_NAME}\`\n> Progress: \`${percent}%\`\n> Completed Tasks: \`${idx}/${TOTAL}\`" 
                  fi
                  echo "Sending progress notification to Slack..."
                  curl -s -X POST -H 'Content-Type: application/json' \
                      --data "{\"text\":\"${msg}\"}" \
                      "$SLACK_WEBHOOK_URL"
                fi
              fi

              # main.py „ÅÆÁµÇ‰∫Ü„Çπ„ÉÜ„Éº„Çø„Çπ„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÁµÇ‰∫Ü„Åï„Åõ„Çã
              echo "Exiting with status ${status}"
              exit $status
          resources:
            requests:
              memory: "8Gi"
              cpu: "6"
            limits:
              nvidia.com/gpu: 1
              memory: "10Gi"
              cpu: "10"
          env:
            - name: TZ
              value: "Asia/Tokyo"
            - name: S3_BUCKET
              value: "gpu-perf-predictor"
            - name: S3_ENDPOINT_URL
              value: "192.168.0.50:9000"
            - name: S3_ACCESS_KEY
              value: "minioadmin"
            - name: S3_SECRET_KEY
              value: "Ashushu0810@"
            - name: TOTAL_COMPLETIONS
              value: "3000" # „Çø„Çπ„ÇØÁ∑èÊï∞
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: slack-webhook-secret
                  key: url
            - name: JOB_COMPLETION_INDEX
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                      - PLACEHOLDER # „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„Éé„Éº„ÉâÂêç„ÅåÂÖ•„Çã
