apiVersion: batch/v1
kind: Job
metadata:
  name: task-runner-job
spec:
  completionMode: Indexed
  completions: 3000 # ã“ã®Jobã§å®Œäº†ã•ã›ã‚‹Podã®ç·æ•° (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ 0 ã‹ã‚‰ 29 ã¾ã§) ->ã€€ã‚¿ã‚¹ã‚¯ç·æ•°
  parallelism: 1 # åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹Podã®æœ€å¤§æ•°
  backoffLimitPerIndex: 1 # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã”ã¨ã«PODã‚’2å›ã¾ã§ä½œã‚Šç›´ã™
  ttlSecondsAfterFinished: 10 # çµ‚äº†å¾Œ 10 ç§’ã§ã‚¬ãƒ™ãƒ¼ã‚¸GC

  template:
    spec:
      restartPolicy: Never
      containers:
        - name: task-runner-container
          image: genyuuu/task-runner-pytorch:latest
          command:
            - /bin/bash
            - -c
            - |
              # ---------- å®Ÿã‚¿ã‚¹ã‚¯ ----------
              python main.py

              # ---------- çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ----------
              status=$?

              # ---------- æ¡ä»¶ä»˜ã Slack é€šçŸ¥ ----------
              TOTAL=$TOTAL_COMPLETIONS
              STEP=$(( (TOTAL + 9) / 10 ))  # 10%åˆ»ã¿

              idx=$(( JOB_COMPLETION_INDEX + 1 ))

              if (( idx % STEP == 0 || idx == TOTAL )); then
                percent=$(( (idx * 100 + TOTAL/2) / TOTAL ))   # å››æ¨äº”å…¥

                if (( percent == 100 )); then
                  # ===== 100 %: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ =====
                  msg="${NODE_NAME}: ğŸ‰ *${JOB_NAME}* å®Œäº† (${idx}/${TOTAL})"
                else
                  # ===== é€šå¸¸ 10 % ã”ã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ =====
                  msg="${NODE_NAME}: âœ… ${JOB_NAME}: ${percent}% é€²è¡Œä¸­ (${idx}/${TOTAL})"
                fi

                curl -s -X POST -H 'Content-Type: application/json' \
                    --data "{\"text\":\"${msg}\"}" \
                    "$SLACK_WEBHOOK_URL"
              fi
          resources:
            limits:
              nvidia.com/gpu: 1
          env:
            - name: TZ
              value: "Asia/Tokyo"
            - name: S3_BUCKET
              value: "gpu-perf-predictor"
            - name: S3_ENDPOINT_URL
              value: "192.168.0.50:9000"
            - name: S3_ACCESS_KEY
              value: "minioadmin"
            - name: S3_SECRET_KEY
              value: "Ashushu0810@"
            - name: JOB_COMPLETION_INDEX
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
            - name: JOB_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['job-name']
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: slack-webhook-secret
                  key: url
            - name: TOTAL_COMPLETIONS
              value: "3000" # ã‚¿ã‚¹ã‚¯ç·æ•°
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                      - PLACEHOLDER # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒãƒ¼ãƒ‰åã‚’å…¥ã‚Œã‚‹
